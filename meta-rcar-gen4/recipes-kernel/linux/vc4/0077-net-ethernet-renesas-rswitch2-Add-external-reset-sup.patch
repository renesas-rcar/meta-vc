From ef0a97e0480a8ddd90b390d933845207ecc1560b Mon Sep 17 00:00:00 2001
From: Dennis Ostermann <dennis.ostermann@renesas.com>
Date: Fri, 26 May 2023 12:42:44 +0200
Subject: [PATCH 77/92] net: ethernet: renesas: rswitch2: Add external reset
 support

---
 drivers/net/ethernet/renesas/rswitch2/rswitch2.h       | 2 ++
 drivers/net/ethernet/renesas/rswitch2/rswitch2_main.c  | 4 ++++
 drivers/net/ethernet/renesas/rswitch2/rswitch2_platf.c | 6 ++++++
 3 files changed, 12 insertions(+)

diff --git a/drivers/net/ethernet/renesas/rswitch2/rswitch2.h b/drivers/net/ethernet/renesas/rswitch2/rswitch2.h
index 0e072836b0cf..cc1081c680e6 100644
--- a/drivers/net/ethernet/renesas/rswitch2/rswitch2.h
+++ b/drivers/net/ethernet/renesas/rswitch2/rswitch2.h
@@ -9,6 +9,7 @@
 
 #include <linux/if_ether.h>
 #include <linux/phy.h>
+#include <linux/reset.h>
 
 
 
@@ -86,6 +87,7 @@ struct rswitch2_drv {
 	void __iomem *ptp_base_addr;
 	void __iomem *sram_base_addr;  /* for sram debug and pps output control */
 	struct device *dev;
+	struct reset_control *sd_rst;
 	u32 num_of_cpu_ports;
 	u32 num_of_tsn_ports;
 	u32 ports_intialized;
diff --git a/drivers/net/ethernet/renesas/rswitch2/rswitch2_main.c b/drivers/net/ethernet/renesas/rswitch2/rswitch2_main.c
index 638f09dbe8df..d6bdfa0d4485 100644
--- a/drivers/net/ethernet/renesas/rswitch2/rswitch2_main.c
+++ b/drivers/net/ethernet/renesas/rswitch2/rswitch2_main.c
@@ -18,6 +18,10 @@ static void rswitch2_reset(struct rswitch2_drv *rsw2)
 {
 	iowrite32(RRC_RR, rsw2->coma_base_addr + RSW2_COMA_RRC);
 	iowrite32(0x0, rsw2->coma_base_addr + RSW2_COMA_RRC);
+
+	reset_control_assert(rsw2->sd_rst);
+	mdelay(1);
+	reset_control_deassert(rsw2->sd_rst);
 }
 
 static void rswitch2_clock_enable(struct rswitch2_drv *rsw2)
diff --git a/drivers/net/ethernet/renesas/rswitch2/rswitch2_platf.c b/drivers/net/ethernet/renesas/rswitch2/rswitch2_platf.c
index abed70ec4c4f..d392134a16a0 100644
--- a/drivers/net/ethernet/renesas/rswitch2/rswitch2_platf.c
+++ b/drivers/net/ethernet/renesas/rswitch2/rswitch2_platf.c
@@ -450,6 +450,12 @@ static int rswitch2_platf_probe(struct platform_device *pdev)
 
 	/* Set driver private data */
 	platform_set_drvdata(pdev, drv_priv);
+
+	rsw2->sd_rst = devm_reset_control_get(&pdev->dev, "eth-phy");
+	if (IS_ERR(rsw2->sd_rst)) {
+		dev_err(&pdev->dev, "Failed to get reset control: %ld\n", PTR_ERR(rsw2->sd_rst));
+		return PTR_ERR(rsw2->sd_rst);
+	}
 	//drv_priv->pdev = pdev;
 	rsw2->base_addr = devm_ioremap_resource(&pdev->dev, res_rsw2);
 	if (IS_ERR(rsw2->base_addr))
-- 
2.30.2

