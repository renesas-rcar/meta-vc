#!/bin/sh

PROP_RE='drivers/net/ethernet/microchip/lan865x|drivers/net/phy/marvell_88q3344_es.c'

inc=vc4_kernel_patches.inc
inc_prop=vc4_kernel_patches_proprietary.inc

dir=vc4
dir_prop=vc4-proprietary

defconfig=arch/arm64/configs/renesas-vc4_defconfig

if [ $# -ne 1 ]; then
	echo "Usage: $0 <kernel-dir>" >&2
	exit 1
fi

kdir="$1"
if [ ! -d "$kdir/kernel" -o ! -d "$kdir/drivers" ]; then
	echo "$kdir does not look like kernel source directory" >&2
	exit 1
fi

base=$(awk -F'"' '/SRCREV/ {print($2)}' linux-renesas-source.inc)
count=$(cd $kdir && git log --oneline $base.. | wc -l)
if [ "$count" -eq 0 -o "$count" -gt 300 ]; then
	echo "Too many patches, is $kdir correct?" >&2
	exit 1
fi

rm -rf $dir $dir_prop
mkdir $dir $dir_prop

dst=$(cd $dir && pwd)
(cd $kdir &&
 git format-patch -o $dst $base.. >/dev/null &&
 cp $defconfig $dst/defconfig)

for p in $dir/*.patch; do egrep -q "$PROP_RE" $p && mv $p $dir_prop/; done

rm -f $inc $inc_prop

echo '# Auto-generated by '$(basename $0) >> $inc
echo '' >> $inc
echo 'FILESEXTRAPATHS_prepend := "${THISDIR}/'$dir':"' >> $inc
echo '' >> $inc
echo 'PATCHES += "\' >> $inc
for p in $(cd $dir && echo *.patch); do
	echo '  file://'$p' \' >> $inc
done
echo '"' >> $inc

echo '# Auto-generated by '$(basename $0) >> $inc_prop
echo '' >> $inc_prop
echo 'FILESEXTRAPATHS_prepend := "${THISDIR}/'$dir_prop':"' >> $inc_prop
echo '' >> $inc_prop
echo 'PATCHES += "\' >> $inc_prop
for p in $(cd $dir_prop && echo *.patch); do
	echo '  file://'$p' \' >> $inc_prop
done
echo '"' >> $inc_prop

