#!/bin/sh

# Keep this in sync with SRCREV from
# meta-renesas/meta-rcar-gateway/recipes-bsp/u-boot/u-boot_2020.10.bb
base=d6d9868e0a93f015993afc3d1542528e6d4bfa46

inc=vc4_u-boot_patches.inc
dir=vc4

if [ $# -ne 1 ]; then
	echo "Usage: $0 <u-boot-repo-dir>" >&2
	exit 1
fi

kdir="$1"
if [ ! -d "$kdir/board" -o ! -d "$kdir/cmd" ]; then
	echo "$kdir does not look like u-boot source directory" >&2
	exit 1
fi

count=$(cd $kdir && git log --oneline $base.. | wc -l)
if [ "$count" -eq 0 -o "$count" -gt 300 ]; then
	echo "Too many patches, is $kdir correct?" >&2
	exit 1
fi

rm -rf $dir
mkdir $dir

dst=$(cd $dir && pwd)
(cd $kdir && git format-patch -o $dst $base.. >/dev/null)

rm -f $inc

echo '# Auto-generated by '$(basename $0) >> $inc
echo '' >> $inc
echo 'FILESEXTRAPATHS_prepend := "${THISDIR}/'$dir':"' >> $inc
echo '' >> $inc
echo 'PATCHES += "\' >> $inc
for p in $(cd $dir && echo *.patch); do
	echo '  file://'$p' \' >> $inc
done
echo '"' >> $inc
